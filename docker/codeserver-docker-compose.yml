# purpose: this runs codeserver container with pyenv container support
# navigate to python project directory:
#   docker exec -it python-env bash
#   cd /workspace/my_project
#   python main.py
# set python interpreter:
#   Ctrl + Shift + P â†’ "Python: Select Interpreter"
#   Enter interpreter path > Find
#   /workspace/.pyenv/versions/3.x.x/bin/python
# install python requirements:
#   pip install -r requirements.txt
# dynamically set password or use env file:
#   JUPYTER_PASSWORD=mysecurepassword docker-compose up -d

services:
  codeserver:
    image: codercom/code-server:latest
    container_name: codeserver
    ports:
      - "3023:8080"
    volumes:
      - /mnt/sec/apps/codeserver/workspace:/home/coder/workspace
      - /mnt/sec/apps/codeserver/pyenv:/home/coder/.pyenv
    environment:
      - PASSWORD=password

  pyenv:
    image: ry4nyeo/codeserver-pyenv:latest
    container_name: pyenv
    ports:
      - "3024:3024"
    volumes:
      - /mnt/sec/apps/codeserver/workspace:/workspace
      - /mnt/sec/apps/codeserver/pyenv:/home/coder/.pyenv
    working_dir: /workspace
    tty: true
    stdin_open: true
    environment:
      - JUPYTER_PASSWORD=${JUPYTER_PASSWORD}  # change password
    command: |
      /bin/bash -c "
      cd ~/.pyenv && git pull &&
      mkdir -p /root/.jupyter &&
      HASHED_PASS=$(python3 -c 'from notebook.auth import passwd; print(passwd(\"${JUPYTER_PASSWORD}\"))') &&
      echo \"c.ServerApp.password = '$HASHED_PASS'\" > /root/.jupyter/jupyter_server_config.py &&
      jupyter notebook --ip=0.0.0.0 --port=3024 --no-browser --allow-root --NotebookApp.token='' &
      exec bash"
